# Defer SSH key loading until first git/ssh operation
function __ensure_ssh_key
    if not set -q SSH_KEY_LOADED
        set -l key_count (ssh-add -L 2>/dev/null | rg -c "felix" || echo 0)
        if test "$key_count" -eq 0
            ssh-add --apple-use-keychain ~/.ssh/id_ed25519
        end
        set -g SSH_KEY_LOADED 1
    end
end

# Wrap git to load SSH keys on demand
function git
    __ensure_ssh_key
    command git $argv
end

# Wrap ssh to load SSH keys on demand
function ssh
    __ensure_ssh_key
    command ssh $argv
end


# Lazy load brew environment only when needed
function __lazy_load_brew
  if not set -q BREW_LOADED
    if test -x /opt/homebrew/bin/brew
      eval (/opt/homebrew/bin/brew shellenv)
    else if test -x /usr/local/bin/brew
      eval (/usr/local/bin/brew shellenv)
    end
    set -g BREW_LOADED 1
  end
end

# Wrap brew command
function brew
  __lazy_load_brew
  command brew $argv
end

# Load brew for GUI apps launched from terminal
function open
  __lazy_load_brew
  command open $argv
end
